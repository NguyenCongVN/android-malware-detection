'''
Upload JSON results from analyais to MongoDb Atlas cluster
.env file holds database username and password

Usage:
	python3 upload_result.py <filename.json>
	
JSON result file is generated from analyze_apks.py
'''
import os
import sys
import json

import pymongo
import load_dotenv, find_dotenv from pydotenv

load_dotenv(find_dotenv())

def get_database(username, password, dbname, collection_name):
	client = pymongo.MongoClient(f"mongodb+srv://{username}:{password}@cluster0.jqguk.mongodb.net/malware?retryWrites=true&w=majority") 
	db = client[dbname]
	collection = db.get_collection(collection_name)
	return collection

def upload_result(json_list):
	DB_USERNAME = os.environ.get("DB_USERNAME")
	DB_PASSWORD = os.environ.get("DB_PASSWORD")
	database = get_database(DB_USERNAME, DB_PASSWORD, "malware", "malware-info")
	database.insert_many(json_list)
	
if __name__ == '__main__':
	file_name = sys.argv[1]
	buffer_string = '['
	buffer_string += open(file_name, 'r').read()
	buffer_string = buffer_string[:len(buffer_string) - 2]
	buffer_string += ']'
	value = json.loads(buffer_string)
	print("Start Uploading")
	upload_result(value)
	print("Finish uploading")

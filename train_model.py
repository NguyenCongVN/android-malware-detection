from pathlib import Path

import hydra
from omegaconf import DictConfig
from pytorch_lightning import Trainer
from pytorch_lightning.callbacks import ModelCheckpoint

from core.data_module import MalwareDataModule
from core.model import MalwareDetector


@hydra.main(config_path="config", config_name="conf")
def train_model(cfg: DictConfig) -> None:
    cwd = Path(hydra.utils.get_original_cwd())
    dataset_directory = cwd / Path(cfg['dataset_directory'])
    if not dataset_directory.exists():
        raise FileNotFoundError(f'{dataset_directory} does not exist. Could not read data from it.')
    output_directory = cwd / Path(cfg['output_directory'])
    if not output_directory.exists():
        output_directory.mkdir(parents=True, exist_ok=True)
    cache = cfg['cache']
    data_module = MalwareDataModule(
        data_dir=dataset_directory,
        batch_size=cfg['batch_size'],
        split_ratios=[0.4, 0.3, 0.3],
        balanced=bool(cfg['balanced']),
        cache = cache
    )
    convolution_count = cfg['convolution_count']
    convolution_dimensions = [64, 64, 32][:min(convolution_count, 3)]
    print(convolution_dimensions)
    feature_list = cfg['features']['attributes']
    readout_weights = cfg['features']['readout_weights']
    input_size = cfg['features']['size']
    gpu = cfg['gpu']
    tpu = cfg['tpu']
    model = MalwareDetector(input_size, convolution_dimensions, feature_list, readout_weights)
    checkpoint_callback = ModelCheckpoint(
        filepath=str(output_directory / '20201123-{epoch:02d}-{val_loss:.2f}.pt'),
        monitor='val_loss',
        mode='min'
    )
    num_epochs = cfg['num_epochs']
    trainer_kwargs = {'gpus': [int(gpu)]} if gpu != 'none' else {}
    trainer_kwargs = {'tpu_cores': int(tpu)} if tpu != 'none' else trainer_kwargs
    trainer = Trainer(callbacks=[checkpoint_callback], max_epochs=num_epochs, **trainer_kwargs)
    trainer.fit(model, data_module)


if __name__ == '__main__':
    train_model()
